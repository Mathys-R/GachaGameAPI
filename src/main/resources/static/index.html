<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gacha Game API Tester</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">
    <h1>Gacha Game API Tester</h1>

    <!-- AUTH SECTION -->
    <div class="auth-container">
        <h2>Authentication</h2>
        <label>Username:</label>
        <input type="text" id="authUsername" placeholder="Enter username">
        
        <label>Password:</label>
        <input type="password" id="authPassword" placeholder="Enter password">
        
        <button onclick="register()">Register</button>
        
        <button onclick="login()">Login</button>
        
        <!-- <button onclick="logout()">Logout</button> -->
        
        <div class="response" id="authResponse">Not authenticated</div>
    </div>

    <!-- PLAYER API -->
    <div class="endpoint">
        <h2>Player API</h2>
        <label>Player Id:</label>        
        <div class="response" id="playerIdResponse">Waiting for response...</div>
        <!-- <button id="btnSavePlayer">Save Player</button>
        <textarea id="playerData" placeholder='{"id": 1, "level": 0, "experience": 0, "inventory": []}'>{"id": 1, "level": 0, "experience": 0, "inventory": []}</textarea>
        <div class="response" id="savePlayerResponse">Waiting for response...</div>
        <button id="btnGetPlayers">Get All Players</button>
        <div class="input-group">
            <input type="number" id="playerId" placeholder="Player ID">
            <button id="btnGetPlayerById">Find Player</button>
        </div> -->
        
        <button id="btnGetPlayerInfo">Get Info</button>
        <div class="response" id="playerInfoResponse">Waiting for response...</div>
        
        <!-- <button id="btnGetLevelXP">Get Level and XP</button>
        <div class="response" id="playerXPResponse">Waiting for response...</div> -->

        <div class="input-group">
            <input type="number" id="xpAmount" placeholder="XP Amount">
            <button id="btnAddXP">Add XP</button>
        </div>
        <div class="input-group">
            <input type="text" id="monsterId" placeholder="Monster ID">
            <!-- <button id="btnAddMonster">Add Monster</button> -->
            <button id="btnRemoveMonster">Remove Monster</button>
        </div>
        <div class="response" id="playerResponse">Waiting for response...</div>
    </div>

    <!-- MONSTERS API -->
    <div class="endpoint">
        <h2>Monsters API</h2>
        
        <button id="btnGetAllMonsters">Get All Available Monsters</button>
        <button id="btnGetMonsters">Get the Info about the Monsters in the inventory</button>
        <!-- <div class="input-group">
            <input type="text" id="monsterIdInput" placeholder="Monster ID">
            <button id="btnGetMonsterById">Find Monster</button>
            <button id="btnDeleteMonster">Delete Monster</button>
        </div> -->
        <div class="response" id="monstersResponse">Waiting for response...</div>
    </div>

    <!-- SUMMON API -->
    <div class="endpoint">
        <h2>Summon API</h2>
       
        <button id="btnSummonMonster">Summon a Monster</button>
        
        <div class="response" id="summonResponse">Waiting for response...</div>

        <!-- Add regenerate functionality -->
        <button id="btnRegenerateSummons">Regenerate Past Summons</button>
        <div class="response" id="regenerateResponse">Waiting for response...</div>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8080"; 
    const API_URL_MONSTERS = "http://localhost:8083/monsters";
    const API_URL_PLAYER = "http://localhost:8082/player";
    const API_URL_AUTH = "http://localhost:8081/auth";
    const API_URL_SUMMON = "http://localhost:8084/summon";

    function getToken() {
        return localStorage.getItem("token") || "";
    }

    function setToken(token) {
        localStorage.setItem("token", token);

        document.getElementById("authResponse").innerText = "Authenticated!";
    }

    function getId() {
        return localStorage.getItem("id") || "";
    }

    function setId(id) {
        localStorage.setItem("id", id);

        document.getElementById("playerIdResponse").innerText = id;
    }

    function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("id");
        document.getElementById("authResponse").innerText = "Logged out!";
    }

    async function fetchAPI(url, method = "GET", body = null, responseElementId = "") {
        try {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            };
            
            console.log(`Sending ${method} request to: ${url}`);
            console.log(`With headers:`, headers);
            if (body) console.log(`With body:`, body);
            
            // Add credentials: 'include' to ensure cookies are sent
            const response = await fetch(url, {
                method,
                headers,
                body: body ? JSON.stringify(body) : null,
                credentials: 'include'
            });

            console.log(`Response status: ${response.status}`);
            console.log(`Response headers:`, response.headers);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`API Error: Status ${response.status}, Body: ${errorText}`);
                throw new Error(`HTTP error! Status: ${response.status}, Message: ${errorText || 'No error details'}`);
            }

            const data = await response.json();
            if (responseElementId) {
                document.getElementById(responseElementId).innerText = JSON.stringify(data, null, 2);
            }
            return data;
        } catch (error) {
            console.error("Error:", error);
            if (responseElementId) {
                document.getElementById(responseElementId).innerText = `API Error: ${error.message}`;
            }
            return null;
        }
    }

    // AUTH: Register and store token
    async function register() {
        const username = document.getElementById("authUsername").value;
        const password = document.getElementById("authPassword").value;

        const responseAuth = await fetch(`${API_URL_AUTH}/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
        });

        if (!responseAuth.ok) {
            document.getElementById("authResponse").innerText = "Registration failed!";
            return;
        }

        const data = await responseAuth.json();
        if (data.token) {
            setToken(data.token); 
        } else {
            document.getElementById("authResponse").innerText = "No token received!";
            return;
        }

        if (data.id) {
            setId(data.id);
        } else {
            document.getElementById("authResponse").innerText = "No ID received!";
            return;
        }

        // console.log("Saving player with ID:", getId());

        const responsePlayer = await fetch(`${API_URL_PLAYER}/save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" ,
                    'Authorization': `Bearer ${getToken()}`},
            body: JSON.stringify({ id: getId() }),
        });

        if (!responsePlayer.ok) {
            document.getElementById("playerIdResponse").innerText = "Id registration for player failed!";
            return;
        }
    }

    async function login() {
        const username = document.getElementById("authUsername").value;
        const password = document.getElementById("authPassword").value;

        const response = await fetch(`${API_URL_AUTH}/re-authenticate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
        });

        if (!response.ok) {
            document.getElementById("authResponse").innerText = "Login failed!";
            return;
        }

        const data = await response.json();
        if (data.token) {
            setToken(data.token); // Store token after successful re-authenticate
        } else {
            document.getElementById("authResponse").innerText = "No token received!";
        }
        
        if (data.id) {
            setId(data.id);
        } else {
            document.getElementById("authResponse").innerText = "No ID received!";
            return;
        }
    }

    // PLAYER API

    document.getElementById("btnGetPlayerInfo").addEventListener("click", async () => {
        const id = getId();
        if (id) {
            await fetchAPI(`${API_URL_PLAYER}/${id}`, "GET", null, "playerInfoResponse");
        } else {
            document.getElementById("playerInfoResponse").innerText = `Error : playerId incorrect`;
        }
    });

    document.getElementById("btnAddXP").addEventListener("click", async () => {
        const id = getId();
        const xp = document.getElementById("xpAmount").value;
        if (id && xp) {
            await fetchAPI(`${API_URL_PLAYER}/${id}/add-xp/${xp}`, "POST", null, "playerResponse");
        } else {
            document.getElementById("playerResponse").innerText = `Error : playerId and/or XP Amount missing`;
        }
    });

    document.getElementById("btnRemoveMonster").addEventListener("click", async () => {
        const playerId = getId();
        const monsterId = document.getElementById("monsterId").value;
        if (playerId && monsterId) {
            await fetchAPI(`${API_URL_PLAYER}/${playerId}/remove-monster/${monsterId}`, "DELETE", null, "playerResponse");
        } else {
            document.getElementById("playerResponse").innerText = `Error : playerId and/or monsterId missing`;
        }
    });

    // MONSTERS API
    document.getElementById("btnGetAllMonsters").addEventListener("click", async () => {
        document.getElementById("monstersResponse").innerText = "Fetching all available monsters...";
        
        // Call the getAllMonsters endpoint
        await fetchAPI(
            `${API_URL_MONSTERS}/`, 
            "GET", 
            null, 
            "monstersResponse"
        );
    });
    
    document.getElementById("btnGetMonsters").addEventListener("click", async () => {
        const playerId = getId();
        if (!playerId) {
            document.getElementById("monstersResponse").innerText = "Error: playerId missing";
            return;
        }
        
        try {
            // First get the monster IDs from player inventory
            document.getElementById("monstersResponse").innerText = "Fetching player's monster inventory...";
            const playerResponse = await fetchAPI(`${API_URL_PLAYER}/${playerId}`, "GET");//////////////////////////////////////////////////////
            
            if (!playerResponse) {
                document.getElementById("monstersResponse").innerText = "Error: Player inventory not found.";
                return;
            }
            
            const monsterIds = playerResponse.inventory;
            if (!monsterIds.length) {
                document.getElementById("monstersResponse").innerText = "Player has no monsters in inventory.";
                return;
            }
            
            // Now fetch details for these monster IDs
            document.getElementById("monstersResponse").innerText = "Fetching monster details...";
            // Try using a POST request with the IDs in the body
            const monstersDetails= await fetchAPI(
                    `${API_URL_MONSTERS}/list?ids=${monsterIds.join(',')}`, 
                    "GET", 
                    null, 
                    "monstersResponse"
                );
        } catch (error) {
            console.error("Error fetching monsters:", error);
            document.getElementById("monstersResponse").innerText = `Error fetching monster details: ${error.message}`
            // document.getElementById("monstersResponse").innerText = `${playerResponse.inventory}`;
        }
    });

    // SUMMON API
    document.getElementById("btnSummonMonster").addEventListener("click", async () => {
        const id = getId();
        const token = getToken();
        
        if (!id) {
            document.getElementById("summonResponse").innerText = "Error: playerId missing";
            return;
        }
        
        if (!token) {
            document.getElementById("summonResponse").innerText = "Error: Not authenticated. Please login first.";
            return;
        }
        
        document.getElementById("summonResponse").innerText = "Summoning monster...";
        
        console.log("Current token:", token);
        console.log("Current player ID:", id);
        
        // Use the exact endpoint format from the SummonController
        await fetchAPI(
            `${API_URL_SUMMON}/${id}/${token}`, 
            "POST", 
            null, 
            "summonResponse"
        );
    });

    // Add regenerate functionality based on SummonController
    document.getElementById("btnRegenerateSummons").addEventListener("click", async () => {
        const id = getId();
        if (!id) {
            document.getElementById("regenerateResponse").innerText = "Error: playerId missing";
            return;
        }
        
        document.getElementById("regenerateResponse").innerText = "Regenerating summons...";
        
        // This would typically require past summons data
        // For testing purposes, we'll use an empty array
        const pastSummons = [];
        
        await fetchAPI(
            `${API_URL_SUMMON}/${id}/regenerate`, 
            "POST", 
            pastSummons, 
            "regenerateResponse"
        );
    });
</script>
</body>
</html>
